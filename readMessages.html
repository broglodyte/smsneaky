<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
    <title>Read Messages</title>
    <script src="https://code.jquery.com/jquery-1.12.4.js">
</script> <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js">
</script> <script>
$( function() {
	$( "#accordion" ).accordion({
		collapsible: true
	});
} );

var msgDict = {};
var senderList = [];

$(document).ready( function() {
	$.getJSON("/inbox", function(result) {
		if(result) {
			jsonData = result;
			
			$.each(jsonData, (index, message) => {
				var sender = message.sender || 'Unknown';
				var senderMsgList;
				
				if(!msgDict[sender])
					msgDict[sender] = [];
				
				if(senderList.indexOf(sender) === -1)
					senderList.push(sender);
				
				//senderMsgList = msgDict[sender];
				msgDict[sender].push(message);
			});
			
			for (senderKey in msgDict) {
				var msgHtml = $('<H2></H2>').text(senderKey);
				var msgList = msgDict[senderKey].sort((a,b) => {return a.timestamp<b.timestamp?-1:1});
				$("div#accordion").append(msgHtml);
				
				for(msgBlob in msgList) {
					var message = document.createElement("div");
					message.innerHTML = `<p class="datetime">${msgBlob.datetime}</p>\n<p class="msgText">${msgBlob.payload}</p>\n<hr>\n\n`;
					$("div#asccordion").append(message);
				}
			}
			
		}
	});
});
    </script>
</head>

<body>
	<div id="accordion">
	
	
	</div>
</body>
</html>
